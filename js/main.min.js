(function(){var n,e,o,t,r,i,a,s,l,c,d,u,f,m;o=null,m=0,r=window.env={rootcolumn:null,domobject:{},formData:null,randindex:0,formId:"",formName:"",formVersion:"",teamId:"",focusBox:null},$.fn.resetForm=function(){var n;return n=this,$.each(n.find(".error"),function(n,e){$(e).data("title","").removeClass("error").tooltip("destroy")}),n},s=function(n){var e,o;return o=new RegExp("(^|&)"+n+"=([^&]*)(&|$)","i"),e=window.location.search.substr(1).match(o),e?decodeURI(e[2]):""},l=function(){var n,e,o,t,r,i,a,s,l;for(e=config.boxes,t=[],r=0,a=e.length;a>r;r++){for(n=e[r],t.push('<ul class="nav nav-list accordion-group">\n  <li class="nav-header">\n    <i class="glyphicon-plus glyphicon"></i> '+n[0]+'\n    <div class="pull-right popover-info"><i class="glyphicon glyphicon-question-sign"></i>\n      <div class="popover fade right">\n        <div class="arrow"></div>\n        <h3 class="popover-title">提示：</h3>\n        <div class="popover-content">'+n[1]+'</div>\n      </div>\n    </div>\n  </li>\n  <li class="boxes" id="estRows">'),l=n.slice(2),i=0,s=l.length;s>i;i++)o=l[i],t.push('<div class="box" cls="'+o[0]+'" label="'+o[1]+'" param="'+(o[2]||"")+'">\n  <span class="drag label label-default"><i class="glyphicon glyphicon-move"></i> 拖动</span>\n  <div class="preview"><span>'+o[1]+"</span></div>\n</div>");t.push("  </li>\n</ul>")}return t.join("\n")},t=function(n){return n.draggable({connectToSortable:".column",helper:"clone",handle:".drag",start:function(n,e){var t;return m=1,t=e.helper.attr("cls"),window[t]?(o=new window[t](e.helper.attr("label"),e.helper.attr("param")),o.className=t):(o=new window.BoxBase,console.log(""+t+" don't exist, use BoxBase instead.")),e.helper.empty().append(o.drapview).css({width:400,opacity:.5})}})},f=function(n){return n.sortable({connectWith:".column",opacity:.75,handle:".drag",start:function(n,e){return e.helper.css({opacity:.8})},update:function(n,t){var i,a,s;return m?(m=0,a=$(t.item[0]),a.attr("objinx",r.randindex),a.html('<span class="drag label label-default"><i class="glyphicon glyphicon-move"></i> 拖动</span>\n<span class="remove label label-danger"><i class="glyphicon glyphicon-remove"></i> 删除</span>\n<span class="boxname label label-default">'+o.name+'</span>\n<div class="configuration"></div>\n<div class="view"></div>'),s=a.find("div.view"),s.append(o.editview),a.find("div.configuration").append(o.toolview),o.initdom(a),r.domobject[r.randindex++]=o,i=s.find("div.column"),i[0]&&(i.each(function(n,e){return $(e).attr("inx",n)}),f(i)),e(a,r)):void 0}})},window.sortit=f,i=function(n,e,o,t){var r,i,a,s;return a=function(){var n;n=[];for(i in o)r=o[i],r&&n.push(i);return n}(),s="(function(w){\n  if(!w.boxCssCache){\n    w.boxCssCache = {};\n  }\n  var i, x, css = "+JSON.stringify(a)+";\n  for(i=0; i<css.length; i++){\n    if(!w.boxCssCache[css[i]]){\n      $('head').append('<link href=\""+(t?config.excsspath:config.outcsspath)+"'+ css[i] +'.css\" rel=\"stylesheet\">');\n      w.boxCssCache[css[i]] = 1;\n    }\n  }\n  if(!w.boxCssCache['"+n+"']){\n    $('head').append('<style>"+e.replace(/'/g,"\\'")+"</style>');\n    w.boxCssCache['"+n+"'] = 2;\n  }\n}).call(this,window);",s.replace(/\s*\/\/[^\n\r]*[\r\n]?/gm,"\n").replace(/\s*[\r\n]+\s*/gm,"").replace(/^\s+|\s+$/g,"")},a=function(n,e,o,t){var r;return r='(function(window, $, jQuery){\nvar console = window.console || {log: function(){}},\ndom, box, boxfuns = {}, seriesGetData, doSetData, queue;\n//全局接口的入口，查找当前的dom得到id号进行调用，这样可以避免全局污染\nwindow["box'+n+'"] = function(dt, callback){\n  if(!dom || !doSetData){\n    //简单起见，这里只保存最新的一个调用值\n    queue = [dt, callback];\n    return;\n  }\n  if($.isFunction(dt)){\n    callback = dt;\n    //在这里先调用validate的方法进行表单验证\n    if(dom.valid && !dom.valid()){\n      return callback("valid failed.");\n    }\n    seriesGetData(dom, function(err, dt){\n      callback(err, dt);\n    });\n  }else{\n    //设置新的表单数据\n    doSetData(dt, dom, callback);\n  }\n};\nasync.forEachOfSeries('+JSON.stringify(o)+', function(item, key, callback){\n  try{\n    if(eval(item)){\n      $.ajax("'+(t?config.exjspath:config.outjspath)+"\"+key+\".js\",{\n        contentType: 'text/plain',\n        dataType:'text',\n        mimeType: 'text/plain',\n        cache:true,\n        success:function(dt){\n          var tdef = window.define;\n          //暂时取消define\n          window.define = null;\n          var spt = document.createElement('script');\n          spt.innerHTML = dt;\n          $('head').append(spt);\n          window.define = tdef;\n          callback(0);\n        },\n        error: function(xhr, ts, ex){\n          callback(ex);\n        }\n      });\n    }else{\n      callback(0);\n    }\n  }catch(ex){\n    callback(ex);\n  }\n}, function(err){\n  dom = $(\"#box"+n+'"),\n  //所有的插件需要调用的方法都放在这里，请用push的方法实现\n  //考虑到有一些需求可能需要用到异步请求，所以所有的调用都异步调用\n  box = {};\n  if(dom.validate){\n    dom.validate({\n      debug:true,\n      showErrors: function(errorMap, errorList) {\n        $.each(this.validElements(), function (index, element) {\n            var $element = $(element);\n            $element.data("title", "") // Clear the title - there is no error associated anymore\n                .removeClass("error")\n                .tooltip("destroy");\n        });\n        $.each(errorList, function (index, error) {\n            var $element = $(error.element);\n            $element.tooltip("destroy") // Destroy any pre-existing tooltip so we can repopulate with new tooltip content\n                .data("title", error.message)\n                .addClass("error")\n                .tooltip(); // Create a new tooltip based on the error messsage we just set in the title\n        });\n      }\n    });\n  }else{\n    console.log("plugin validate not found. ignore it.");\n  }\n  '+e+'\n  //进行dom初始化\n  boxfuns.initdom = function(domx){\n    var allbox = domx.find("[boxclass]");\n    allbox.each(function(){\n      var t = $(this);\n      var cls = t.attr(\'boxclass\');\n      if(box[cls] && box[cls].initdom){\n        box[cls].initdom(t, dom, box, boxfuns); //把box传过去是为了有继承关系的类，因为派生而需要调基类的方法\n      }\n    });\n  };\n  boxfuns.initdom(dom);\n  //遍历整个dom，并得到验证之后的数据，如果有错误的话就提示错误\n  boxfuns.getValue = seriesGetData = function(dom, callback){\n    var nix = {}, nos = {}, out = {}, rootdom = dom;\n    var allbox = dom.find("[boxname]:visible");\n    async.eachSeries(allbox, function(t, callback){\n      t = $(t);\n      var cls = t.attr(\'boxclass\');\n      var name = t.attr(\'boxname\');\n      var extend = $.parseJSON(Base64.decode(t.attr(\'boxextend\')));\n      //把得到的数据值填充到输出的对象中\n      var setval = function(v){\n        var parentNode = t.parent().closest("[boxname]");\n        if(parentNode[0] == rootdom[0]){\n          parentNode = []; //针对只得到部分的dom片段\n        }\n        if($.isArray(v)){\n          if(v.length > 0){\n            //如果有值说明插件内部已经自己处理了，这里框架就不用关心了\n            //这里只处理没有值的情况\n            extend.value = v;\n            out[name] = extend;\n            return;\n          }\n          //因dom的结构和接口定义的结构不一样，遍历起来真的好麻烦\n          if(!nix[name]){\n            t.parent().children(\'[boxname=\'+ name +\']\').each(function(){\n              var t = $(this);\n              if(nix[name]){\n                nix[name]++;\n              }else{\n                nix[name] = 1;\n              }\n              t.attr("boxinx", nix[name]); //作一个索引的标记\n              if(!nos[name]){\n                extend.value = [{}];\n                nos[name] = extend;\n              }else{\n                nos[name].value[nix[name]-1] = {}; //先造好容器\n              }\n            });\n            if(parentNode[0]){\n              var inx = parseInt(parentNode.attr(\'boxinx\'))-1;\n              nos[parentNode.attr(\'boxname\')].value[inx][name] = nos[name];\n            }else{\n              out[name] = nos[name];\n            }\n          }\n          return;\n        }\n\n        extend.value = v;\n        //查找应该放到哪个位置\n        if(parentNode[0]){\n          var inx = parseInt(parentNode.attr(\'boxinx\'))-1;\n          nos[parentNode.attr(\'boxname\')].value[inx][name] = extend;\n        }else{\n          out[name] = extend;\n        }\n      };\n      if(box[cls] && box[cls].getValue){\n        box[cls].getValue(t, function(err, v){\n          if(err){\n            return callback(err);\n          }\n          setval(v);\n          callback(0);\n        });\n      }else{\n        if(t.find(\'div.column\')[0]){\n          setval([]);\n        }else{\n          console.log("Can\'t find box: "+ cls);\n          setval(\'\');\n        }\n        callback(0);\n      }\n    }, function(err){\n      callback(err, out);\n    });\n  };\n  var valueToHtml = function(o, v, callback){\n    var boxclass = o.attr("boxclass");\n    if(box[boxclass] && box[boxclass].setValue){\n      box[boxclass].setValue(o, v, callback);\n    }else{\n      console.log("INFO: box "+ boxclass + " or box.setValue no found, ignore it.");\n      callback(0);\n    }\n  };\n  //这里采用多重循环dom，效率方面可能有点低，因一般情况下dom的查询并不多，暂时还看不到性能的瓶颈\n  boxfuns.setValue = doSetData = function(dt, dom, callback){\n    // Clear errer status\n    dom.find(".error").data("title", "").removeClass("error").tooltip("destroy");\n    async.eachOfSeries(dt, function(item, key, callback){\n      var o = dom.find("[boxname="+ key +"]");\n      if(o[0]){\n        var value = item.value;\n        if($.isArray(value)){\n          // 如果是数组的话说明是有多组的，再进行遍历\n          valueToHtml($(o[0]), value, function(err){\n            //重新获取新的列表，因为可能已经更新\n            var os = o.parent().children("[boxname="+ key +"]");\n            async.eachOfSeries(value, function(item, key, callback){\n              if(os[key]){\n                doSetData(item, $(os[key]), callback);\n              }else{\n                //如果不存在将忽略\n                console.log("ignore "+ key);\n                callback(0);\n              }\n            }, callback);\n          });\n        }else{\n          valueToHtml(o, value, callback);\n        }\n      }else{\n        console.log("Ignore box: " + key);\n        callback(0);\n      }\n    }, callback);\n  };\n  //查找执行事件\n  if(queue) {\n    window["box'+n+'"](queue[0], queue[1]);\n    queue = null;\n  }\n});\n}).call(this, window, window.jQuery, window.jQuery);',r.replace(/\s*\/\/[^\n\r]*[\r\n]?/gm,"\n").replace(/\s*[\r\n]+\s*/gm,"").replace(/^\s+|\s+$/g,"")},u=function(n){return document.title=(n.formName?""+n.formName+" - ":"[未命名] - ")+"Box"},d=function(n,e,o){var t;return t=Math.round(1e4*Math.random()),async.waterfall([function(e){return async.series({css:function(e){return toCss(n,e)},js:function(e){return toJs(n,e)},excss:function(e){return toExcss(n,e)},exjs:function(e){return toExjs(n,e)}},e)},function(o,r){return toHtml(n,function(n,s){var l;return e?(l='<html><head>\n  <meta charset="utf-8">\n  <style>html,body{padding:0;margin:0;}div.layout{padding:40px 10px 20px 10px}</style>\n  <script src="'+config.exjspath+'jquery.min.js"></script>\n  <script src="'+config.exjspath+'async.js"></script>\n</head><body>\n  <script>'+i(t,o.css,o.excss,e)+'</script>\n  <div class="layout"><form class="boxview" id="box'+t+'">'+s+"</form></div>\n  <script>"+a(t,o.js,o.exjs,e)+"</script>\n</body></html>",l=l.replace(/\s*[\r\n]+\s*/gm,"").replace(/^\s+|\s+$/g,"")):l=JSON.stringify([i(t,o.css,o.excss,e),'<form class="boxview" id="box'+t+'">'+s+"</form>",a(t,o.js,o.exjs,e)]),r(n,l,t)})}],o)},c=function(n,e){return $.post(""+config.rooturl+"/itsm/request/getFormSerializationByFormIdAndVersion.spr",{formId:n.formId,formVersion:n.formVersion},function(o){return(null!=o?o.retCode:void 0)?($.notify(o.retDetail,"error"),void e(o.redCode,o)):jsonToDom(JSON.parse(o.data.formSerialization),n,function(n){return n?($.notify(n,"error"),e(n)):e(n,o.data)})},"json")},n={list:function(){var n;return n=$("#formList"),$.post(""+config.rooturl+"/itsm/request/getFormListEditByUser.spr",null,function(e){var o,t,r,i,a,s,l,c,d,u,f,m,p,v,b,x,h,g,y,w;if(e.retCode)return $.notify(e.retDetail,"error");for(t=['<div class="tree"><ul>'],v=e.data,s=0,u=v.length;u>s;s++){if(r=v[s],t.push('<li teamFieldId="'+r.teamFieldId+'"><span><i class="glyphicon glyphicon-tasks"></i> '+r.teamFieldName+"</span>"),null!=(b=r.teamList)?b[0]:void 0){for(t.push("<ul>"),x=r.teamList,l=0,f=x.length;f>l;l++){if(i=x[l],t.push('<li teamId="'+i.teamId+'"><span><i class="glyphicon glyphicon-minus"></i> '+i.teamName+"</span>"),null!=(h=i.formList)?h[0]:void 0){for(t.push("<ul>"),g=i.formList,c=0,m=g.length;m>c;c++){if(o=g[c],t.push('<li formId="'+o.formId+'"><span><i class="glyphicon glyphicon-minus"></i> '+o.formName+"</span>"),null!=(y=o.formVersionList)?y[0]:void 0){for(t.push("<ul><li>"),w=o.formVersionList,d=0,p=w.length;p>d;d++)a=w[d],t.push('<span class="vn" version="'+a+'"><i class="glyphicon glyphicon-tag"></i> '+a+"</span>");t.push("</li></ul>")}t.push("</li>")}t.push("</ul>")}t.push("</li>")}t.push("</ul>")}t.push("</li>")}return t.push("</ul></div>"),n.modal("show"),n.find("div.modal-body").css("height",n.height()-200).html(t.join("")),n.find(".tree li:has(ul)").addClass("parent_li").find(" > span").attr("title","Collapse this branch"),n.find(".tree li.parent_li > span").click(function(n){var e;n.stopPropagation(),e=$(this).parent("li.parent_li").find(" > ul > li"),e.is(":visible")?(e.hide("fast"),$(this).attr("title","Expand this branch").find(" > i").addClass("glyphicon-plus").removeClass("glyphicon-minus")):(e.show("fast"),$(this).attr("title","Collapse this branch").find(" > i").addClass("glyphicon-minus").removeClass("glyphicon-plus"))}),n.find(".tree .vn").click(function(){return n.find(".tree .vn").removeClass("active"),$(this).addClass("active")}).dblclick(function(){return n.find("[act=loadform]").trigger("click")})},"json")},preview:function(n,e){return d(e,1,function(n,o,t){var r,i,a,s,l,c;for(a=$("#previewModal"),a.modal("show"),i=$('<iframe frameborder="0" height="'+(a.height()-200)+'" width="100%"></iframe>'),a.find("div.modal-body").empty().append(i),i[0].contentDocument.open(),i[0].contentDocument.write(o),i[0].contentDocument.close(),c=e.rootcolumn.find("div.box[objinx]"),s=0,l=c.length;l>s;s++){r=c[s];try{$(r).children("span.boxname").html(e.domobject[r.getAttribute("objinx")].name)}catch(d){}}return window.boxViewtype=function(){return i[0].contentWindow["box"+t](function(n,o){return n?void $.notify("出错啦，可能验证没有通过"):(e.formData=o,console.log(o),$.notify("已经在控制台上打印了结果","success"))})},window.restoreDataFun=function(){return e.formData?i[0].contentWindow["box"+t](e.formData,function(n){return n?(console.log(n),$.notify("恢复数据失败")):$.notify("恢复数据成功","success")}):$.notify("请先点击“查看数据”获取数据")}})},viewtype:function(){return window.boxViewtype()},restoreData:function(){return window.restoreDataFun()},save:function(n,e,o){var t,r;return r=o[1],r||(r="newForm"),"updateVersion"!==r||e.formId&&e.formVersion||(r="newForm"),"newVersion"!==r||e.formId||(r="newForm"),t=function(){return domToStruct(e,function(n,o){return n?console.log(n):$.post(""+config.rooturl+"/itsm/request/insertFormDataStructure.spr",{formDataStructure:JSON.stringify(o),formId:e.formId,formName:e.formName,formVersion:e.formVersion,teamId:e.teamId,type:r},function(n){return(null!=n?n.retCode:void 0)?console.log(n.retDetail):(n=n.data,n.formId&&(e.formId=n.formId),n.formVersion&&(e.formVersion=n.formVersion),structToDom(n.dataStructureJson,e,function(o){return o?console.log(o):domToJson(e,function(o,t){return o?console.log(o):$.post(""+config.rooturl+"/itsm/request/updateFormSerialization.spr",{formSerialization:JSON.stringify(t),formId:e.formId,formVersion:e.formVersion},function(){return(null!=n?n.retCode:void 0)?console.log(n.retDetail):d(e,0,function(n,o){return n?console.log(n):$.post(""+config.rooturl+"/itsm/request/updateFormHtml.spr",{formHtml:o,formId:e.formId,formVersion:e.formVersion},function(n){return n.retCode||$.notify("保存成功","success"),console.log(n,e,"Save End")},"json")})},"json")})}))},"json")})},e.formName&&"newForm"!==r?t():$.post(""+config.rooturl+"/itsm/request/getFormListEditByUser.spr",function(n){var o,r,i,a,s,l,c,d,f,m,p,v;if(n.retCode)return $.notify(n.retDetail);for(s=[],p=n.data,c=0,f=p.length;f>c;c++){for(l=p[c],s.push('<optgroup label="'+l.teamFieldName+'">'),v=l.teamList,d=0,m=v.length;m>d;d++)a=v[d],i=a.teamId===e.teamId?" selected":"",s.push('<option value="'+a.teamId+'"'+i+">"+a.teamName+"</option>");s.push("</optgroup>")}return r=$("#formName"),o=r.find("form"),o.find("input:text").val(e.formName),o.resetForm(),o.find("select").html(s.join("")),r.modal("show"),o.unbind("submit").submit(function(n){return n.preventDefault(),o.valid()?(e.formName=o.find("input:text").val(),e.teamId=o.find("select").val(),r.modal("hide"),u(e),t()):void 0})})},loadform:function(n,e){var o,t;return o=$("#formList"),t=o.find(".tree span.active"),t[0]?(e.formVersion=t.attr("version"),e.formId=t.closest("[formid]").attr("formid"),e.teamId=t.closest("[teamid]").attr("teamid"),c(e,function(n,o){return n?n:(e.formName=o.formName,u(e))}),o.modal("hide")):$.notify("请选择表单","error")},jsonData:function(n,e){return domToJson(e,function(n,e){return n?($.notify("数据错误"),console.log(n)):(console.log(JSON.stringify(e)),$.notify("已经在控制台打印了结果","success"))})}},e=function(n,e){var o,t,r;if(r=n.attr("objinx"),e.domobject[r]){if(e.focusBox){if(t=e.focusBox.attr("objinx"),t===r)return;o=$("div.pubinfo>.infoview"),e.domobject[t].removePropertyView(o,e.focusBox),e.focusBox.removeClass("boxactive")}return e.focusBox=n,o=$('<div class="infoview"></div>'),$("div.pubinfo").empty().append(o),e.domobject[r].updatePropertyView(o,n),n.addClass("boxactive")}},$(function(){var o,i,a,d;return d=$("div.sidebar-nav").html(l()),d.find("li.boxes:first").show(),d.find("li.nav-header").click(function(){return d.find("li.boxes").hide(),$(this).next().slideDown()}),t(d.find("div.box")),a=$("div.column"),r.rootcolumn=a,f(a),o=s("formId"),i=s("formVersion"),o&&i?(r.formId=o,r.formVersion=i,c(r,function(n,e){return n?n:(r.formName=e.formName,u(r))})):(jsonToDom([["DynamicLayout","dynamiclayout",[["Input","input"]]],["TabLayout",["tablayout",{tabs:[["a",""],["b",""],["c",""]],focus:1}],[["Input","input1"]],null,[["Input","input2"]]]],r,function(){}),u(r)),a.mousedown(function(n){var o,t,i,a;return i=$(n.target).closest(".box[objinx]"),i[0]?void e(i,r):void(r.focusBox&&(t=r.focusBox.attr("objinx"),o=$("div.pubinfo>.infoview"),null!=(a=r.domobject[t])&&a.removePropertyView(o,r.focusBox),r.focusBox.removeClass("boxactive"),r.focusBox=null,$("div.pubinfo").empty()))}),$(".modal form").each(function(){return $(this).validate({debug:!0,showErrors:function(n,e){return $.each(this.validElements(),function(n,e){$(e).data("title","").removeClass("error").tooltip("destroy")}),$.each(e,function(n,e){$(e.element).tooltip("destroy").data("title",e.message).addClass("error").tooltip()})}})}),a.delegate(".remove","click",function(n){var e,o,t,i;return n.preventDefault(),i=$(this).parent(),t=i.attr("objinx"),r.focusBox&&r.focusBox[0]===i[0]&&(o=r.focusBox.attr("objinx"),e=$("div.pubinfo>.infoview"),r.domobject[o].removePropertyView(e,r.focusBox),r.focusBox=null,$("div.pubinfo").empty()),r.domobject[t].beforeRemove(i),i.remove(),delete r.domobject[t]}),a.delegate(".boxname","click",function(n){var e,o,t,i,a,s;return n.preventDefault(),o=$(this),s=o.parent(),a=s.attr("objinx"),i=r.domobject[a],e=$("#boxName"),t=e.find("form"),t.find("input:text").val(i.name),t.resetForm(),e.modal("show"),t.unbind("submit").submit(function(n){var r;return n.preventDefault(),t.valid()?(r=t.find("input:text").val(),e.modal("hide"),console.log(r),i.setName(r),o.html(r)):void 0})}),$("ul.nav,div.modal").delegate("[act]","click",function(e){var o,t,i;return e.preventDefault(),t=$(e.target).closest("[act]"),o=t.attr("act").split("|"),"function"==typeof n[i=o[0]]?n[i](e,r,o):void 0})})}).call(this);