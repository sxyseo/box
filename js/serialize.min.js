(function(){var n,e,t,o,r,i,a,s,c,u;n=function(n){var e,t;return e=0,t={},n.find("div.column").each(function(n,e){var o,r;return e=$(e),r=e.closest("div[objinx]"),r[0]?(o=r.attr("objinx"),t[o]||(t[o]=0),e.attr("inx",t[o]++)):void 0})},t=function(e,t){var o,r,i,a,s;return i=e.domobject,r=e.rootcolumn,s=[],a={},o={},n(r),async.eachSeries(r.find("div[objinx]"),function(n,e){var t,r,c,u;if(n=$(n),r=n.attr("objinx"),c=i[r],!c||a[r])return e(1);if(o[c.name]){for(t=1;o[c.name+t];)t++;c.setName(c.name+t)}return u=[n.attr("cls")],a[r]=u,o[c.name]=u,c.toJson(function(t,o){var r,i,c,l;if(t)return e(t);if(u.push(o),i=n.parent(".column[inx]"),i[0]){if(c=i.closest("div[objinx]"),l=a[c.attr("objinx")],!l)return e(1);r=parseInt(i.attr("inx"))+2,l[r]||(l[r]=[]),l[r].push(u)}else s.push(u);return e(0)})},function(n){return t(n,s)})},r=function(n,e,t){var o;return o=function(n,t,r){return async.eachSeries(n,function(n,r){var i,a;i=n[0];try{a=new window[i],a.className=i}catch(s){console.log(""+i+" don't exist, use BoxBase instead."),a=new window.BoxBase}return a.fromJson(n[1],function(s){var c,u,l;return s?r(s):(u=$('<div class="box ui-draggable" cls="'+i+'" objinx="'+e.randindex+'">\n  <span class="drag label label-default"><i class="glyphicon glyphicon-move"></i> 拖动</span>\n  <span class="remove label label-danger"><i class="glyphicon glyphicon-remove"></i> 删除</span>\n  <span class="boxname label label-default">'+a.name+'</span>\n  <div class="configuration"></div>\n  <div class="view"></div>\n</div>'),t.append(u),l=u.find("div.view"),l.append(a.editview),u.find("div.configuration").append(a.toolview),a.initdom(u),e.domobject[e.randindex]=a,e.randindex++,c=l.find("div.column"),c[0]&&(c.each(function(n,e){return $(e).attr("inx",n)}),sortit(c)),async.forEachOf(n.slice(2),function(n,e,t){var r;return r=l.find("div.column[inx="+e+"]"),r[0]?o(n,r,t):(console.log(""+i+" don't exist column "+e+", ignore it."),t(0))},r))})},r)},e.rootcolumn.empty(),o(n,e.rootcolumn,t)},c=function(e,t){var o,r,i,a,s;return i=e.domobject,r=e.rootcolumn,s=[],a={},o={},n(r),async.eachSeries(r.find("div[objinx]"),function(n,e){var t,r,c;if(n=$(n),r=n.attr("objinx"),c=i[r],!c||a[r])return e(1);if(o[c.name]){for(t=1;o[c.name+t];)t++;c.setName(c.name+t)}return c.toHtml(function(t,i){var u,l,f,d,m;if(t)return e(t);if(i=i.replace(/(['"])\s*[\r\n]+\s*/gm,"$1 ").replace(/\s*[\r\n]+\s*/gm,"").replace(/^\s+|\s+$/g,""),i=i.replace(/^(\<[a-zA-Z]+)/,'$1 boxclass="'+c.className+'" boxname="'+c.name+'" boxextend="'+c.extend+'"'),l=[i],a[r]=l,o[c.name]=l,f=n.parent(".column[inx]"),f[0]){if(d=f.closest("div[objinx]"),m=a[d.attr("objinx")],!m)return e(1);u=parseInt(f.attr("inx"))+1,m[u]||(m[u]=[]),m[u].push(l)}else s.push(l);return e(0)})},function(n){var e,o,r,i,a;for(o=function(n){var e,t,r,i,a,s,c,u,l,f,d;if(n.length>1){for(a=n[0],e=n.slice(1),r=u=0,f=e.length;f>u;r=++u)if(s=e[r]){for(i=l=0,d=s.length;d>l;i=++l)c=s[i],s[i]=c.length>1?o(c):c[0];e[r]=s.join("")}else e[r]="";return t=0,a.replace(/(<div [^\n>]*?class=[^\n>=]*?column[^\n>]*?>)(<\/div>)/g,function(n,o,r){return""+o+(e[t++]||"")+r})}return n[0]},e=i=0,a=s.length;a>i;e=++i)r=s[e],s[e]=o(r);return t(n,s.join(""))})},e={},i=function(n,t){var o,r,i,a,s,c,u,l,f;o={},l=n.domobject;for(i in l)for(s=l[i],f=s.css,c=0,u=f.length;u>c;c++)r=f[c],o[r]=1;return a=[],async.eachSeries(Object.keys(o),function(n,t){return e[n]?(a.push(e[n]),t(0)):$.ajax(""+config.boxpath+n+".user.css?"+(new Date).getTime(),{contentType:"text/plain",dataType:"text",mimeType:"text/plain",success:function(o){return o=o.replace(/\/\*[\s\S]*?\*\//gm,"").replace(/\s*[\r\n]+\s*/gm,"").replace(/^\s+|\s+$/g,""),e[n]=o,a.push(o),t(0)},error:function(e,o){return console.log("Request "+config.boxpath+n+".user.css failed: "+o),t(1)}})},function(n){return t(n,a.join(""))})},o={},u=function(n,e){var t,r,i,a,s,c,u,l,f;t={},l=n.domobject;for(i in l)for(s=l[i],f=s.js,c=0,u=f.length;u>c;c++)r=f[c],t[r]=1;return a=[],async.eachSeries(Object.keys(t),function(n,e){return o[n]?(a.push(o[n]),e(0)):$.ajax(""+config.boxpath+n+".user.js?"+(new Date).getTime(),{contentType:"text/plain",dataType:"text",mimeType:"text/plain",success:function(t){return t=t.replace(/\/\*[\s\S]*?\*\//gm,"").replace(/\s*\/\/[^\n\r]*[\r\n]?/gm,"\n").replace(/\s*[\r\n]+\s*/gm,"").replace(/^\s+|\s+$/g,""),t="box."+n+"={};(function(box){"+t+"})(box."+n+");",o[n]=t,a.push(t),e(0)},error:function(t,o){return console.log("Request "+config.boxpath+n+".user.js failed: "+o),e(1)}})},function(n){return e(n,a.join(""))})},a=function(n,e){var t,o,r,i,a,s,c;t={},s=n.domobject;for(o in s){i=s[o],c=i.excss;for(r in c)a=c[r],t[r]=a}return e(0,t)},s=function(n,e){var t,o,r,i,a,s,c;t={},s=n.domobject;for(o in s){i=s[o],c=i.exjs;for(r in c)a=c[r],t[r]=a}return e(0,t)},window.domToJson=t,window.jsonToDom=r,window.toHtml=c,window.toCss=i,window.toJs=u,window.toExcss=a,window.toExjs=s}).call(this);